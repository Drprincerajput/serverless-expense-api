name: Destroy Terraform Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to destroy (dev or prod)"
        required: true
        default: "dev"

jobs:
  destroy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set Terraform backend config
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "dev" ]]; then
          cp infra/backend-dev.tf infra/backend.tf
        elif [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
          cp infra/backend-prod.tf infra/backend.tf
        else
          echo "Invalid environment. Use 'dev' or 'prod'."
          exit 1
        fi

    - name: Terraform destroy
      run: |
        cd infra
        terraform init -reconfigure
        terraform destroy -var-file=../${{ github.event.inputs.environment }}/terraform.tfvars -auto-approve
